#include "fsm_automatic.h"
void init_automatic_mode() {
    light_state1 = RED_STATE;
    light_state2 = GREEN_STATE;

    Red_Counter_temp1    = Red_Counter;
    Green_Counter_temp1  = Green_Counter;
    Yellow_Counter_temp1 = Yellow_Counter;

    Red_Counter_temp2    = Red_Counter;
    Green_Counter_temp2  = Green_Counter;
    Yellow_Counter_temp2 = Yellow_Counter;
}
void fsm_automatic_run()
{
    if (system_state != NORMAL_STATE) return;

    // ====================================================
    // NÚT BẤM CHUYỂN SANG TUNNING
    // ====================================================
    if (is_button_pressed(0)) {
                system_state = TUNNING_STATE;
                setting_state = TUNNING_RED_STATE; // Vào Mode 2

                // Load giá trị hiện tại vào biến tạm để chỉnh sửa
                Pre_Red_Counter = Red_Counter;

                // Reset timer nháy đèn cho Mode 2
                setTimer0(250); // 2Hz = 500ms chu kỳ -> toggle mỗi 250ms
                blink = 0;

                lcd_clear_display();
                return;
            }


    if (system_state == NORMAL_STATE) {
    		// TL1
    	 if (!timer2_flag) return;
    	    timer2_flag = 0;

    	    //====================================================
    	    //                XỬ LÝ TRAFFIC LIGHT 1
    	    //====================================================
    	    switch (light_state1)
    	    {
    	        case RED_STATE:
    	            RGB_TrafficLight_TurnOn(RGB_tl1, RED_STATE);
    	            if (Red_Counter_temp1 == 0) {
    	                Red_Counter_temp1 = Red_Counter;
    	                Green_Counter_temp1 = Green_Counter;     // chuyển sang GREEN
    	                light_state1 = GREEN_STATE;
    	            } else {
    	                Red_Counter_temp1--;
    	            }
    	            break;

    	        case GREEN_STATE:
    	            RGB_TrafficLight_TurnOn(RGB_tl1, GREEN_STATE);
    	            if (Green_Counter_temp1 == 0) {
    	                Green_Counter_temp1 = Green_Counter;
    	                Yellow_Counter_temp1 = Yellow_Counter;   // chuyển sang YELLOW
    	                light_state1 = YELLOW_STATE;
    	            } else {
    	                Green_Counter_temp1--;
    	            }
    	            break;

    	        case YELLOW_STATE:
    	            RGB_TrafficLight_TurnOn(RGB_tl1, YELLOW_STATE);
    	            if (Yellow_Counter_temp1 == 0) {
    	                Yellow_Counter_temp1 = Yellow_Counter;
    	                Red_Counter_temp1 = Red_Counter;         // quay lại RED
    	                light_state1 = RED_STATE;
    	            } else {
    	                Yellow_Counter_temp1--;
    	            }
    	            break;
    	    }
    	    //====================================================
    	    //                XỬ LÝ TRAFFIC LIGHT 2
    	    //====================================================
    	    switch (light_state2)
    	    {
    	        case RED_STATE:
    	            RGB_TrafficLight_TurnOn(RGB_tl2, RED_STATE);
    	            if (Red_Counter_temp2 == 0) {
    	                Red_Counter_temp2 = Red_Counter;
    	                Green_Counter_temp2 = Green_Counter;
    	                light_state2 = GREEN_STATE;
    	            } else {
    	                Red_Counter_temp2--;
    	            }
    	            break;

    	        case GREEN_STATE:
    	            RGB_TrafficLight_TurnOn(RGB_tl2, GREEN_STATE);
    	            if (Green_Counter_temp2 == 0) {
    	                Green_Counter_temp2 = Green_Counter;
    	                Yellow_Counter_temp2 = Yellow_Counter;
    	                light_state2 = YELLOW_STATE;
    	            } else {
    	                Green_Counter_temp2--;
    	            }
    	            break;

    	        case YELLOW_STATE:
    	            RGB_TrafficLight_TurnOn(RGB_tl2, YELLOW_STATE);
    	            if (Yellow_Counter_temp2 == 0) {
    	                Yellow_Counter_temp2 = Yellow_Counter;
    	                Red_Counter_temp2 = Red_Counter;
    	                light_state2 = RED_STATE;
    	            } else {
    	                Yellow_Counter_temp2--;
    	            }
    	            break;
    	    }

    	    setTimer2(25000);
    	}
    if (timer3_flag) {
          timer3_flag = 0;

          updateLCDBuffer();

          // chọn tốc độ update
          setTimer3(10000);
      }
  }
