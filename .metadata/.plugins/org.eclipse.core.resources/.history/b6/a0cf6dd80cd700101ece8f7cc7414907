#include "fsm_automatic.h"
void init_automatic_mode() {
//    light_state1 = RED_STATE;
//    light_state2 = GREEN_STATE;
//
//    Red_Counter_temp1    = Red_Counter;
//    Green_Counter_temp1  = Green_Counter;
//    Yellow_Counter_temp1 = Yellow_Counter;
//
//    Red_Counter_temp2    = Red_Counter;
//    Green_Counter_temp2  = Green_Counter;
//    Yellow_Counter_temp2 = Yellow_Counter;

	if (Red_Counter != Green_Counter + Yellow_Counter) {
	         // Tự động tính lại Green nếu sai lệch
	         if(Red_Counter > Yellow_Counter)
	             Green_Counter = Red_Counter - Yellow_Counter;
	         else {
	             // Fallback nếu dữ liệu sai hoàn toàn
	             Red_Counter = 5; Yellow_Counter = 2; Green_Counter = 3;
	         }
	    }

	    // 2. Thiết lập trạng thái ban đầu: ĐỎ - XANH (Thay vì Đỏ - Vàng)
	    light_state1 = RED_STATE;
	    light_state2 = GREEN_STATE; // <--- SỬA Ở ĐÂY (Code cũ có thể bạn đang để nhầm hoặc logic sai)

	    // 3. Nạp thời gian cho các biến đếm chạy (temp)
	    // Đèn 1 bắt đầu là ĐỎ
	    Red_Counter_temp1    = Red_Counter;
	    Green_Counter_temp1  = Green_Counter;
	    Yellow_Counter_temp1 = Yellow_Counter;

	    // Đèn 2 bắt đầu là XANH -> Phải nạp thời gian XANH vào biến đếm hiện tại
	    Red_Counter_temp2    = Red_Counter;
	    Green_Counter_temp2  = Green_Counter; // <--- QUAN TRỌNG: Đếm Green trước
	    Yellow_Counter_temp2 = Yellow_Counter;
}

void fsm_automatic_run()
{
    // ... (Giữ nguyên phần đầu hàm)

    if (system_state == NORMAL_STATE) {
        if (!timer2_flag) return;
        timer2_flag = 0;

        //====================================================
        //                XỬ LÝ TRAFFIC LIGHT 1
        //====================================================
        switch (light_state1)
        {
            case RED_STATE:
                Red_Counter_temp1--; // <--- SỬA: Trừ trước
                if (Red_Counter_temp1 <= 0) { // <--- Kiểm tra ngay
                    Red_Counter_temp1 = Red_Counter;
                    Green_Counter_temp1 = Green_Counter;
                    light_state1 = GREEN_STATE;
                    // Bật đèn mới ngay lập tức để đồng bộ
                    RGB_TrafficLight_TurnOn(RGB_tl1, GREEN_STATE);
                } else {
                    // Nếu chưa hết giờ thì giữ nguyên đèn cũ
                    RGB_TrafficLight_TurnOn(RGB_tl1, RED_STATE);
                }
                break;

            case GREEN_STATE:
                Green_Counter_temp1--; // <--- SỬA: Trừ trước
                if (Green_Counter_temp1 <= 0) {
                    Green_Counter_temp1 = Green_Counter;
                    Yellow_Counter_temp1 = Yellow_Counter;
                    light_state1 = YELLOW_STATE;
                    RGB_TrafficLight_TurnOn(RGB_tl1, YELLOW_STATE);
                } else {
                    RGB_TrafficLight_TurnOn(RGB_tl1, GREEN_STATE);
                }
                break;

            case YELLOW_STATE:
                Yellow_Counter_temp1--; // <--- SỬA: Trừ trước
                if (Yellow_Counter_temp1 <= 0) {
                    Yellow_Counter_temp1 = Yellow_Counter;
                    Red_Counter_temp1 = Red_Counter;
                    light_state1 = RED_STATE;
                    RGB_TrafficLight_TurnOn(RGB_tl1, RED_STATE);
                } else {
                    RGB_TrafficLight_TurnOn(RGB_tl1, YELLOW_STATE);
                }
                break;
        }

        //====================================================
        //                XỬ LÝ TRAFFIC LIGHT 2
        //====================================================
        // Áp dụng logic tương tự cho đèn 2: Trừ trước -> Kiểm tra
        switch (light_state2)
        {
            case RED_STATE:
                Red_Counter_temp2--;
                if (Red_Counter_temp2 <= 0) {
                    Red_Counter_temp2 = Red_Counter;
                    Green_Counter_temp2 = Green_Counter;
                    light_state2 = GREEN_STATE;
                    RGB_TrafficLight_TurnOn(RGB_tl2, GREEN_STATE);
                } else {
                    RGB_TrafficLight_TurnOn(RGB_tl2, RED_STATE);
                }
                break;

            case GREEN_STATE:
                Green_Counter_temp2--;
                if (Green_Counter_temp2 <= 0) {
                    Green_Counter_temp2 = Green_Counter;
                    Yellow_Counter_temp2 = Yellow_Counter;
                    light_state2 = YELLOW_STATE;
                    RGB_TrafficLight_TurnOn(RGB_tl2, YELLOW_STATE);
                } else {
                    RGB_TrafficLight_TurnOn(RGB_tl2, GREEN_STATE);
                }
                break;

            case YELLOW_STATE:
                Yellow_Counter_temp2--;
                if (Yellow_Counter_temp2 <= 0) {
                    Yellow_Counter_temp2 = Yellow_Counter;
                    Red_Counter_temp2 = Red_Counter;
                    light_state2 = RED_STATE;
                    RGB_TrafficLight_TurnOn(RGB_tl2, RED_STATE);
                } else {
                    RGB_TrafficLight_TurnOn(RGB_tl2, YELLOW_STATE);
                }
                break;
        }

        // Timer chạy mỗi 1s
        setTimer2(1000);

    // ... (Giữ nguyên phần cập nhật LCD)

    	}
    if (timer3_flag) {
          timer3_flag = 0;

          updateLCDBuffer();

          // chọn tốc độ update
          setTimer3(10000);
      }
  }
